"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("mobx-state-tree"),t=e.createActionTrackingMiddleware2({filter:function(e){return!e.env},onStart:function(t){var r=e.recordPatches(t.tree,(function(r,n,o){return!!o&&e.isActionContextThisOrChildOf(o,t.id)}));r.resume(),t.env={recorder:r}},onFinish:function(e,t){var r=e.env.recorder;e.env=void 0,r.stop(),void 0!==t&&r.undo()}}),r=function(){return(r=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function n(e,t){var r,n,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,n=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],n=0}finally{r=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}function o(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function a(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,a=r.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(n=a.next()).done;)i.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=a.return)&&r.call(a)}finally{if(o)throw o.error}}return i}function i(e){var t=Object.assign({},e);return delete t.type,{name:e.type,args:[t]}}function s(e,t,r){!function e(n){var o=t.shift();o?o(e)(n):r(n)}(e)}function c(t){return e.getType(t).name||"(UnnamedType)"}var u=e.types.model("TimeTraveller",{history:e.types.array(e.types.frozen()),undoIdx:-1,targetPath:""}).views((function(e){return{get canUndo(){return e.undoIdx>0},get canRedo(){return e.undoIdx<e.history.length-1}}})).actions((function(t){var r,n,o=!1;return{addUndoState:function(e){o?o=!1:(t.history.splice(t.undoIdx+1),t.history.push(e),t.undoIdx=t.history.length-1)},afterCreate:function(){var o=this;if(!(r=t.targetPath?e.resolvePath(t,t.targetPath):e.getEnv(t).targetStore))throw new Error("Failed to find target store for TimeTraveller. Please provide `targetPath` property, or a `targetStore` in the environment");n=e.onSnapshot(r,(function(e){return o.addUndoState(e)})),0===t.history.length&&this.addUndoState(e.getSnapshot(r))},beforeDestroy:function(){n()},undo:function(){t.undoIdx--,o=!0,e.applySnapshot(r,t.history[t.undoIdx])},redo:function(){t.undoIdx++,o=!0,e.applySnapshot(r,t.history[t.undoIdx])}}})),d=e.types.model("UndoManagerEntry",{patches:e.types.frozen(),inversePatches:e.types.frozen()}),l=e.types.model("UndoManager",{history:e.types.array(d),undoIdx:0}).views((function(e){return{get undoLevels(){return e.undoIdx},get redoLevels(){return e.history.length-e.undoIdx},get canUndo(){return this.undoLevels>0},get canRedo(){return this.redoLevels>0}}})).actions((function(r){var a,i=0,s=[],c=e.createActionTrackingMiddleware2({filter:function(e){return!e.env&&e.context!==r},onStart:function(t){var r=e.recordPatches(t.tree,(function(r,n,o){return!i&&(!!o&&e.isActionContextThisOrChildOf(o,t.id))}));r.resume(),t.env={recorder:r}},onFinish:function(e,t){var n=e.env.recorder;if(e.env=void 0,n.stop(),void 0===t)if(s.length>0){var o=s[s.length-1];o.patches=o.patches.concat(n.patches),o.inversePatches=o.inversePatches.concat(n.inversePatches)}else r.addUndoState(n);else n.undo()}}),u=function(e){i++;try{return e()}finally{i--}};return{addUndoState:function(t){this.withoutUndo((function(){if(0!==t.patches.length){r.history.splice(r.undoIdx),r.history.push({patches:t.patches,inversePatches:t.inversePatches});var n=e.getEnv(r).maxHistoryLength||1/0;r.history.splice(0,r.history.length-n),r.undoIdx=r.history.length}}))},afterCreate:function(){var t=e.getRoot(r);if((a=e.getEnv(r).targetStore||t)===r)throw new Error("UndoManager should be created as part of a tree, or with `targetStore` in it's environment");e.addDisposer(r,e.addMiddleware(a,c,!1))},undo:e.decorate(t,(function(){u((function(){if(!r.canUndo)throw new Error("undo not possible, nothing to undo");e.applyPatch(e.getRoot(a),r.history[r.undoIdx-1].inversePatches.slice().reverse()),r.undoIdx--}))})),redo:e.decorate(t,(function(){u((function(){if(!r.canRedo)throw new Error("redo not possible, nothing to redo");e.applyPatch(e.getRoot(a),r.history[r.undoIdx].patches),r.undoIdx++}))})),withoutUndo:function(e){return u(e)},withoutUndoFlow:function(t){return e.flow((function(){return n(this,(function(e){switch(e.label){case 0:i++,e.label=1;case 1:return e.trys.push([1,,3,4]),[5,o(t())];case 2:return[2,e.sent()];case 3:return i--,[7];case 4:return[2]}}))}))},startGroup:function(e){if(s.length>=1)throw new Error("a previous startGroup is still running, did you forget to call stopGroup?");return s.push({patches:[],inversePatches:[]}),e()},stopGroup:function(){var e=s.pop();if(!e)throw new Error("each call to stopGroup requires a previous call to startGroup, did you forget to call startGroup?");this.addUndoState(e)},clear:e.decorate(t,(function(){u((function(){r.history.clear(),r.undoIdx=0}))})),clearUndo:e.decorate(t,(function(){u((function(){r.history.splice(0,r.undoLevels),r.undoIdx=0}))})),clearRedo:e.decorate(t,(function(){u((function(){r.history.splice(r.undoIdx,r.redoLevels)}))}))}}));exports.TimeTraveller=u,exports.UndoManager=l,exports.actionLogger=function(t,r){"action"===t.type&&0!==t.parentId||"flow_resume"===t.type||"flow_resume_error"===t.type||console.log("[MST] #"+t.rootId+" "+t.type+" - "+e.getPath(t.context)+"/"+t.name),r(t)},exports.asReduxStore=function(t){for(var r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];if(!e.isStateTreeNode(t))throw new Error("Expected model object");var o={getState:function(){return e.getSnapshot(t)},dispatch:function(r){s(r,a.slice(),(function(r){return e.applyAction(t,i(r))}))},subscribe:function(r){return e.onSnapshot(t,r)}},a=r.map((function(e){return e(o)}));return o},exports.atomic=t,exports.connectReduxDevtools=function(t,n,o){var i=r({logIdempotentActionSteps:!0,logChildActions:!1,logArgsNearName:!0},o),s=0,u=t.connectViaExtension({name:e.getType(n).name});u.subscribe((function(r){"DISPATCH"===r.type&&function(r,n,o){try{switch(s++,o.payload.type){case"RESET":return e.applySnapshot(n,d),r.init(d);case"COMMIT":return r.init(e.getSnapshot(n));case"ROLLBACK":return r.init(t.extractState(o));case"JUMP_TO_STATE":case"JUMP_TO_ACTION":return void e.applySnapshot(n,t.extractState(o));case"IMPORT_STATE":var a=o.payload.nextLiftedState,i=a.computedStates;e.applySnapshot(n,i[i.length-1].state),r.send(null,a)}}finally{s--}}(u,n,r)}));var d=e.getSnapshot(n);u.init(d);var l=new Map,p=void 0;i.logIdempotentActionSteps||e.onPatch(n,(function(){!s&&p&&p()})),e.addMiddleware(n,(function(t,r){if(s)return void r(t);for(var o,d=t.allParentIds.length-1;d>=0;d--){var f=t.allParentIds[d],h=l.get(f);if(h){o=h;break}}if("action"===t.type||!o){var y=function(t){for(var r=t,n=[];r;)n.unshift(c(r)),r=e.hasParent(r)?e.getParent(r):void 0;return n}(t.context).join("/"),g=o,v=t.context?"root"+e.getPath(t.context):"*unknown*";o={name:"["+v+"] "+(t.name||"*unknownAction*"),targetTypePath:y,id:t.id,runningAsync:!1,errored:!1,errorReported:!1,step:"action"===t.type?0:void 0,callArgs:[],changesMadeSetter:void 0},"action"===t.type&&(t.args&&(o.callArgs=function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(a(arguments[t]));return e}(t.args)),t.parentId&&(o.parent=g),l.set(t.id,o))}var w=!1;o.changesMadeSetter=function(){w=!0};var S,x=p;p=o.changesMadeSetter;try{r(t)}catch(e){S=e,o.errored=!0}p=x,o.changesMadeSetter=void 0;var m=!!i.logIdempotentActionSteps||w;switch(t.type){case"flow_spawn":case"flow_resume":case"flow_resume_error":o.runningAsync=!0;for(var b=o.parent;b;)b.runningAsync=!0,b=b.parent;break;case"flow_throw":o.errored=!0}var P="action"===t.type&&!o.runningAsync||"flow_resume"===t.type||"flow_throw"===t.type&&!o.errorReported;i.logChildActions||!o.parent||o.runningAsync||(P=!1,w&&o.parent.changesMadeSetter&&o.parent.changesMadeSetter());if(P){var T=function(t){var r=e.getSnapshot(n),a=function e(t,r){var n=t.name,o=t.targetTypePath;if(r){var a=t.callArgs.map((function(e){return JSON.stringify(e)})).join(", ");a.length>64&&(a=a.slice(0,64)+"..."),n+="("+a+")"}if(t.runningAsync&&(n+=" ("+(void 0!==t.step?t.step:"?")+")"),t.errored&&(n+=" -error thrown-"),t.parent){var i=e(t.parent,r);i&&(n=i.name+" >>> "+n,o=i.targetTypePath+" >>> "+o)}return{name:n,targetTypePath:o}}(t,i.logArgsNearName),s={type:a.name,targetTypePath:a.targetTypePath,args:t.callArgs};u.send(s,r),o.errored&&(o.errorReported=!0),void 0!==o.step&&o.step++;for(var c=o.parent;c;)void 0!==c.step&&c.step++,c=c.parent},I=o.parent&&!i.logChildActions;if(m){var A=o;if(I)for(;A.parent;)A=A.parent;T(A)}else I||!o.errored||o.errorReported||T(o)}"flow_return"!==t.type&&"flow_throw"!==t.type&&o.runningAsync||l.delete(o.id);if(S)throw S}),!1)},exports.simpleActionLogger=function(t,r){return"action"===t.type&&0===t.parentId&&console.log("[MST] "+e.getPath(t.context)+"/"+t.name),r(t)};
