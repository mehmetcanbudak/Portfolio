"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,r=1,a=arguments.length;r<a;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ImageElement=void 0;var react_1=__importDefault(require("react")),mobx_react_lite_1=require("mobx-react-lite"),mobx_1=require("mobx"),react_konva_1=require("react-konva"),use_image_1=__importDefault(require("use-image")),konva_1=__importDefault(require("konva")),use_snap_1=require("./use-snap"),crop_1=require("../utils/crop"),useCanvas=function(e){return react_1.default.useMemo((function(){var t,r=document.createElement("canvas");return r.width=e.width,r.height=e.height,null===(t=r.getContext("2d"))||void 0===t||t.drawImage(e,0,0),r}),[e])},loaderCanvas=document.createElement("canvas");loaderCanvas.width=800,loaderCanvas.height=600;var loaderCtx=loaderCanvas.getContext("2d");null==loaderCtx||(loaderCtx.fillStyle="#E5F0F9"),null==loaderCtx||loaderCtx.fillRect(0,0,loaderCanvas.width,loaderCanvas.height),null==loaderCtx||(loaderCtx.textAlign="center"),null==loaderCtx||(loaderCtx.fillStyle="white"),null==loaderCtx||(loaderCtx.font="30px Arial"),null==loaderCtx||loaderCtx.fillText("LOADING....",loaderCanvas.width/2,280),exports.ImageElement=mobx_react_lite_1.observer((function(e){var t=e.onClick,r=e.element,a=e.store,n=react_1.default.useState({width:r.width,height:r.height}),i=n[0],l=n[1];react_1.default.useEffect((function(){l({width:r.width,height:r.height})}),[r.width,r.height]);var o=use_image_1.default(r.src,"Anonymous")[0],u=react_1.default.useRef();react_1.default.useEffect((function(){u.current=o||u.current}),[o]);var s=o||u.current||loaderCanvas,c=react_1.default.useMemo((function(){return crop_1.getCrop(s,i,r.clipDirection)}),[s,i,r.clipDirection]),d=react_1.default.useRef(null);react_1.default.useEffect((function(){return mobx_1.autorun((function(){var e,t=d.current,a={filters:[]};r.blurEnabled&&(a.filters.push(konva_1.default.Filters.Blur),a.blurRadius=r.blurRadius),t.setAttrs(a),a.filters.length?t.cache():t.clearCache(),null===(e=t.getLayer())||void 0===e||e.batchDraw()}))}),[s,c]);var h=use_snap_1.useSnap(d),f=h.onDragMove,_=h.onDragEnd;return react_1.default.createElement(react_konva_1.Image,__assign({ref:d,name:"element",image:s,x:r.x,y:r.y,width:i.width,height:i.height,rotation:r.rotation},c,{draggable:!0,onDragStart:function(){a.selectedElements.find((function(e){return e===r}))||a.selectElements([r.id])},onDragMove:f,onDragEnd:function(e){_(e),r.set({x:e.target.x(),y:e.target.y()})},id:r.id,onClick:function(){t()},onTransform:function(e){var t=e.currentTarget,r=t.scaleX(),a=t.scaleY();t.scaleX(1),t.scaleY(1),l({width:t.width()*r,height:t.height()*a})},onTransformEnd:function(e){var t=e.currentTarget;r.set({width:t.width(),height:t.height(),x:t.x(),y:t.y(),rotation:e.target.rotation()})}}))}));