"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)},__rest=this&&this.__rest||function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(n=Object.getOwnPropertySymbols(e);a<n.length;a++)t.indexOf(n[a])<0&&Object.prototype.propertyIsEnumerable.call(e,n[a])&&(r[n[a]]=e[n[a]])}return r},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var react_1=__importDefault(require("react")),mobx_react_lite_1=require("mobx-react-lite"),mobx_1=require("mobx"),react_konva_1=require("react-konva"),use_image_1=__importDefault(require("use-image")),konva_1=__importDefault(require("konva")),element_1=__importDefault(require("./element")),crop_1=require("../utils/crop"),TEXT_ANCHORS=["top-left","top-right","middle-left","bottom-left","bottom-right","middle-right"],MANY_SHAPES_ANCHORS=["top-left","top-right","bottom-left","bottom-right"],ALL_ANCHORS=["top-left","top-center","top-right","middle-left","bottom-left","bottom-right","bottom-center","middle-right"],Background=function(e){return react_1.default.createElement(react_konva_1.Rect,__assign({},e,{fill:"#e8e8e8"}))},PageBackground=function(e){var t=e.background,r=__rest(e,["background"]),n=t.indexOf("http")>=0||t.indexOf(".png")>=0||t.indexOf(".jpg")>=0,a=use_image_1.default(n?t:"","Anonymous")[0],o=n?react_konva_1.Image:react_konva_1.Rect,i=n&&a?crop_1.getCrop(a,{width:e.width,height:e.height},"center-middle"):{};return react_1.default.createElement(o,__assign({image:a},r,{fill:n?"white":t},i))},Selection=mobx_react_lite_1.observer((function(e){var t=e.selection;return t.visible?react_1.default.createElement(react_konva_1.Rect,{name:"selection",x:Math.min(t.x1,t.x2),y:Math.min(t.y1,t.y2),width:Math.abs(t.x1-t.x2),height:Math.abs(t.y1-t.y2),fill:"rgba(0, 161, 255, 0.3)"}):null}));exports.default=mobx_react_lite_1.observer((function(e){var t=e.store,r=e.page,n=e.xPadding,a=e.yPadding,o=e.width,i=e.height,c=react_1.default.useRef(null);react_1.default.useEffect((function(){var e=mobx_1.autorun((function(){var e,r;if(c.current){var n=c.current.getStage(),a=t.selectedElementsIds.map((function(e){return n.findOne("#"+e)})).filter((function(e){return e}));c.current.nodes(a);var o=1===t.selectedElements.length;o&&"text"===(null===(e=t.selectedElements[0])||void 0===e?void 0:e.type)?c.current.enabledAnchors(TEXT_ANCHORS):o?c.current.enabledAnchors(ALL_ANCHORS):c.current.enabledAnchors(MANY_SHAPES_ANCHORS),null===(r=c.current.getLayer())||void 0===r||r.batchDraw()}}),{delay:50});return function(){return e()}}),[]);var l=react_1.default.useRef(),u=mobx_react_lite_1.useLocalStore((function(){return{visible:!1,x1:0,y1:0,x2:0,y2:0}})),_=function(e){var t,r=e.target.findAncestor(".elements-container"),n=e.target.findAncestor("Transformer");if(!r&&!n){var a=null===(t=e.target.getStage())||void 0===t?void 0:t.getPointerPosition();mobx_1.transaction((function(){u.visible=!0,u.x1=a.x,u.y1=a.y,u.x2=a.x,u.y2=a.y}))}},s=function(e){if(u.visible){var t=e.target.getStage().getPointerPosition();mobx_1.transaction((function(){u.x2=t.x,u.y2=t.y}))}},f=function(){if(u.visible&&l.current){var e=l.current.findOne(".selection").getClientRect(),r=[];l.current.find(".element").toArray().forEach((function(t){var n=t.getClientRect();konva_1.default.Util.haveIntersection(e,n)&&r.push(t.id())})),t.selectElements(r),u.visible=!1,konva_1.default.listenClickTap=!1}},d=function(e){var r=!e.target.findAncestor(".elements-container"),n=e.target.findAncestor("Transformer");r&&!n&&t.selectElements([])};return react_1.default.createElement(react_konva_1.Stage,{ref:l,width:o,height:i,onClick:d,onTap:d,onMouseDown:_,onTouchStart:_,onMouseMove:s,onTouchMove:s,onMouseUp:f,onTouchEnd:f},react_1.default.createElement(react_konva_1.Layer,null,react_1.default.createElement(Background,{width:o,height:i}),react_1.default.createElement(react_konva_1.Group,{x:n,y:a,scaleX:t.scale,scaleY:t.scale,name:"page-container"},react_1.default.createElement(PageBackground,{width:t.width,height:t.height,background:r.background,shadowBlur:10,shadowColor:"lightgrey",name:"page-background"}),react_1.default.createElement(react_konva_1.Group,{clipX:0,clipY:0,clipWidth:t.width,clipHeight:t.height,name:"elements-container"},r.children.map((function(e){return react_1.default.createElement(element_1.default,{key:e.id,store:t,element:e,onClick:function(){t.selectElements([e.id])}})}))),react_1.default.createElement(react_konva_1.Transformer,{ref:c,boundBoxFunc:function(e,t){return t.width<5||t.height<5?e:t}})),react_1.default.createElement(Selection,{selection:u}),!t._isKeyValid&&react_1.default.createElement(react_konva_1.Text,{text:"made with https://polotno.dev",fontSize:14,fill:"rgba(0,0,0,0.6)",x:0,y:0,height:i-3,width:o-3,align:"right",verticalAlign:"bottom",listening:!1,onClick:function(){window.open("https://polotno.dev")}})))}));