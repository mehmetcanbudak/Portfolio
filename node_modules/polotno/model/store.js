"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{l(n.next(e))}catch(e){i(e)}}function s(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,s)}l((n=n.apply(e,t||[])).next())}))},__generator=this&&this.__generator||function(e,t){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,n=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.createStore=exports.Store=exports.Page=exports.SvgModel=exports.ImageModel=exports.TextModel=exports.Element=void 0;var mobx_state_tree_1=require("mobx-state-tree"),mst_middlewares_1=require("mst-middlewares"),nanoid_1=require("nanoid"),download_1=require("../utils/download"),pdf_1=require("../utils/pdf"),validate_key_1=require("../utils/validate-key"),svg_1=require("../utils/svg"),Filter=mobx_state_tree_1.types.model("Filter",{type:"none"});exports.Element=mobx_state_tree_1.types.model("Element",{id:mobx_state_tree_1.types.identifier,type:"none",x:0,y:0,rotation:0,filters:mobx_state_tree_1.types.array(Filter),blurEnabled:!1,blurRadius:10}).views((function(e){return{get page(){return mobx_state_tree_1.getParentOfType(e,exports.Page)}}})).actions((function(e){return{set:function(t){Object.assign(e,t)},moveUp:function(){e.page.moveElementUp(e.id)},moveDown:function(){e.page.moveElementDown(e.id)}}})),exports.TextModel=exports.Element.named("Text").props({text:"",fontSize:14,fontFamily:"Roboto",fontStyle:"",textDecoration:"",fill:"black",align:"center",width:0}).actions((function(e){return{}})),exports.ImageModel=exports.Element.named("Image").props({src:"",clipDirection:"center-middle",width:100,height:100}).actions((function(e){return{}})),exports.SvgModel=exports.Element.named("SVG").props({svgSource:"",svgString:"",width:100,height:100,colorsReplace:mobx_state_tree_1.types.map(mobx_state_tree_1.types.string)}).views((function(e){return{get colors(){return e.svgString?svg_1.getColors(e.svgString):[]},get src(){return e.svgString?svg_1.replaceColors(svg_1.fixSize(e.svgString),e.colorsReplace):this.svgSource}}})).actions((function(e){return{afterCreate:function(){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){switch(r.label){case 0:return[4,svg_1.urlToString(e.src)];case 1:return t=r.sent(),e.set({svgString:t}),[2]}}))}))},replaceColor:function(t,r){e.colorsReplace.set(t,r)}}}));var TYPES_MAP={svg:exports.SvgModel,text:exports.TextModel,image:exports.ImageModel},ElementTypes=mobx_state_tree_1.types.union({dispatcher:function(e){return TYPES_MAP[e.type]}},exports.SvgModel,exports.TextModel,exports.ImageModel),ChildrenType=mobx_state_tree_1.types.array(ElementTypes);function createStore(e){var t=(void 0===e?{}:e).key;return exports.Store.create({key:t})}exports.Page=mobx_state_tree_1.types.model("Page",{id:mobx_state_tree_1.types.identifier,children:ChildrenType,background:"white"}).views((function(e){return{get store(){return mobx_state_tree_1.getParentOfType(e,exports.Store)}}})).actions((function(e){return{set:function(t){Object.assign(e,t)},addElement:function(t){var r=TYPES_MAP[t.type];if(r){var n=r.create(__assign({id:nanoid_1.nanoid(10)},t));return e.children.push(n),e.store.selectElements([n.id]),n}console.error("Can not find model with type "+t.type)},moveElementUp:function(t){var r=e.children.findIndex((function(e){return e.id===t})),n=e.children[r];mobx_state_tree_1.detach(n),e.children.remove(n),e.children.splice(r+1,0,n)},moveElementDown:function(t){var r=e.children.findIndex((function(e){return e.id===t})),n=e.children[r];mobx_state_tree_1.detach(n),e.children.remove(n),e.children.splice(r-1,0,n)}}})),exports.Store=mobx_state_tree_1.types.model("Store",{key:"",_isKeyValid:!0,pages:mobx_state_tree_1.types.array(exports.Page),selectedElementsIds:mobx_state_tree_1.types.array(mobx_state_tree_1.types.string),history:mobx_state_tree_1.types.optional(mst_middlewares_1.TimeTraveller,{targetPath:"../pages"}),scale:1,width:1080,height:1080,_activePageId:""}).views((function(e){return{get selectedElements(){return e.selectedElementsIds.map((function(t){for(var r=0,n=e.pages;r<n.length;r++)for(var o=0,i=n[r].children;o<i.length;o++){var a=i[o];if(a.id===t)return a}}))},get activePage(){return e.pages.slice().find((function(t){return t.id===e._activePageId}))},get elementsById(){return{}},get pagesById(){return{}}}})).actions((function(e){return{afterCreate:function(){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(r){switch(r.label){case 0:return[4,validate_key_1.validateKey(e.key)];case 1:return t=r.sent(),e.___(t),[2]}}))}))},___:function(t){e._isKeyValid=t},addPage:function(t){var r=exports.Page.create(__assign({id:nanoid_1.nanoid(10)},t));return e.pages.push(r),e._activePageId=r.id,r},selectElements:function(t){e.selectedElementsIds=t},setScale:function(t){e.scale=t},setSize:function(t,r){e.width=t,e.height=r},deleteElements:function(t){t.forEach((function(t){e.pages.forEach((function(e){var r=e.children.findIndex((function(e){return e.id===t}));-1!==r&&e.children.splice(r,1)}))})),e.selectedElementsIds=[]},on:function(t,r){if("change"===t)return mobx_state_tree_1.onSnapshot(e,(function(e){r(e)}))},toDataURL:function(t){var r=void 0===t?{}:t,n=r.pixelRatio,o=r.ignoreBackground,i=n||1,a=window.Konva.stages[0],s=a.findOne(".page-container");a.find("Transformer").visible(!1),o&&s.findOne(".page-background").hide();var l=s.toDataURL({x:s.x(),y:s.y(),width:e.width*s.scaleX(),height:e.height*s.scaleY(),pixelRatio:1/s.scaleX()*i});return o&&s.findOne(".page-background").show(),a.find("Transformer").visible(!0),l},saveAsImage:function(t){var r=void 0===t?{}:t,n=r.pixelRatio,o=r.ignoreBackground,i=r.fileName;download_1.downloadFile(e.toDataURL({pixelRatio:n,ignoreBackground:o}),i||"polotno.png","image/png")},saveAsPDF:function(t){var r=(void 0===t?{}:t).pixelRatio;return __awaiter(this,void 0,void 0,(function(){var t,n,o,i;return __generator(this,(function(a){switch(a.label){case 0:return[4,pdf_1.getJsPDF()];case 1:return t=a.sent(),n=new t({unit:"px",format:[e.width,e.height]}),o=n.internal.pageSize.getWidth(),i=n.internal.pageSize.getHeight(),n.addImage(e.toDataURL({pixelRatio:r}),0,0,o,i),n.save("polotno.pdf"),[2]}}))}))},toJSON:function(){var t=__assign({},mobx_state_tree_1.getSnapshot(e));return delete t.history,delete t.key,delete t._isKeyValid,delete t._activePageId,t},loadJSON:function(t){e.pages.forEach((function(e){return e.children.forEach((function(e){return mobx_state_tree_1.detach(e)}))})),e.pages=[],t.key=e.key,t._activePageId=t.pages[0].id,mobx_state_tree_1.applySnapshot(e,t)}}})),exports.createStore=createStore,exports.default=createStore;